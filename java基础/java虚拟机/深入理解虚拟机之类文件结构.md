# 深入理解虚拟机之类文件结构

简单介绍一下Class类文件结构（常量池主要存放的是那两大常量？Class文件的继承关系是如何确定的？**（类索、父类索引、接口索引集合）**字段表、方法表、属性表主要包含那些信息？）

## 1. 概述

　 计算机虽然只能识别0和1，但是越来越多的程序语言选择了与操作系统和机器指令集无关无关的、平台中立的格式作为程序编译后的存储格式。Java虚拟机不和包括Java在内的任何语言绑定，只与 **"Class文件"** 这种特定的二进制文件所关联，Class文件中包含了Java虚拟机指令集合符号表以及若干其它辅助信息。Java虚拟机作为一个通用的、机器无关的执行平台，任何其他语言都可以将其作为语言的产品交付媒介。

![img](https://mmbiz.qpic.cn/mmbiz_png/hvUCbRic69sCTDibHKwMSJuoTeqgrUtp1ItpHb27zxIjHfegxQFxkAgnP3LpG3lsNSmvAZDBHtGAMnwtQ1CK3HmQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

## 2.class类文件结构

Class文件是一组以8位字节为基础的二进制流，各个数据项目严格按照顺序紧凑地排列在Class文件之中，中间没有添加任何分隔符，这使得整个Class文件中存储的内容几乎全部是程序运行的必要数据，没有空隙存在。当遇到需要占用8位字节以上空间的数据项时，则会按照高位在前的方式分割成若干个8位字节进行存储。

Class文件格式采用一种类似于C语言结构体的伪结构来存储数，这种伪结构有两种数据类型：**无符号数**和**表**。

这里需要重复提一下，Class文件结构不像XML等描述语言，由于它没有任何分割符号，所以无论是数量甚至于数据存储的字节序这样的细节都被严格限定，哪个字节代表什么含义，长度是多少，先后顺序如何，都不允许改变。

![img](https://img-blog.csdn.net/20180608201806607?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2E3MjQ4ODg=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

![img](https://img-blog.csdn.net/20180608201829204?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2E3MjQ4ODg=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

### 2.1 魔数与Class文件版本

每个Class文件的头四个字节称为魔数（Magic Number）,它的唯一作用是**确定这个文件是否为一个能被虚拟机接收的Class文件**。紧接着魔数的四个字节存储的是Class文件的版本号：第五和第六是**次版本号**，第七和第八是**主版本号**。

### 2.2 常量池

紧接着主次版本号之后的是常量池入口，**常量池可以理解为Class文件之中的资源仓库**，它是Class文件结构中与其他项目关联最多的数据类型，也是占用Class文件空间最大的数据项目之一，同时它还是在Class文件中第一个出现的表类型数据项目。

常量池的入口需要放置一项U2类型的数据，代表常量池容量计数值。索引范围从1开始。

**常量池主要存放两大常量：字面量和符号引用**。**字面量**比较接近于java语言层面的的常量概念，如文本字符串、声明为final的常量值等。而**符号引用**则属于编译原理方面的概念。包括下面三类常量：

- 类和接口的全限定名
- 字段的名称和描述符
- 方法的名称和描述符

java代码在进行Javac编译的时候，在虚拟机加载Class文件的时候进行动态连接。在Class文件中不会保存各个方法、字段的最终内存布局信息，当虚拟机运行时，需要从常量池获得对应的符号引用，再在类创建时或运行时解析、翻译到具体的内存地址之中。

### 2.3 访问标志

在常量池结束之后，紧接着的两个字节代表访问标志，这个标志用于识别一些类或者接口层次的访问信息，包括：这个Class是类还是接口，是否为public或者abstract类型，如果是类的话是否声明为final等等。具体标志位及标志的含义如下图所示：

![img](https://mmbiz.qpic.cn/mmbiz_png/hvUCbRic69sCTDibHKwMSJuoTeqgrUtp1IM9xnialoXhfkaddVCgbElgKUk6YtFn6z8diboibZ76tLXl8wnu0ueKsbQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### 2.4 类索引、父类索引与接口索引集合

**类索引、父类索引与接口索引集合都按顺序排列在访问标志之后，Class文件由这三项数据来确定这个类的继承关系**。**类索引用于确定这个类的全限定名，父类索引用于确定这个类的父类的全限定名**，由于java语言的单继承，所以父类索引只有一个，除了java.lang.Object之外，所有的java类都有父类，因此**除了java.lang.Object外，所有java类的父类索引都不为0**。**接口索引集合用来描述这个类实现了那些接口**，这些被实现的接口将按implements语句(如果这个类本身是接口的话则是extends)后的接口顺序从左到右排列在接口索引集合中。

### 2.5 字段表集合

**字段表（field info）用于描述接口或类中声明的变量。字段包括类级变量以及实例变量，但不包括在方法内部声明的局部变量。**

**我们可以想一想在java中描述一个字段可以包含什么信息呢?**

字段的作用域（public ,private,protected修饰符），是实例变量还是类变量（static修饰符）、可变性（final）、并发可见性（volatile修饰符，是否强制从主内存读写）、可否被序列化（transient修饰符）、字段数据类型、字段名称。上述这些信息中，各个修饰符都是布尔值，要么有某个修饰符，要么没有，很适合使用标志位来表示。而字段叫什么名字、字段被定义为什么数据类型这些都是无法固定的，只能引用常量池中常量来描述。

**字段的简单名称、字段和方法的描述符、类的全限定名的区别：**

- 类的全限定名：如org/fenixsoft/clazz/TestClass是类的全限定名。

- 字段的简单名称是指没有类型和参数修饰的方法或者字段名称，如inc m.

- 描述符的作用是用来描述字段的数据类型、方法的参数列表（包括数量、类型以及顺序）和返回值。

  **fields_count 、access_flags、name_index、descriptor_index**

  **字段表集合中不会列出从超类或者父接口中继承而来的字段**

### 2.6方法表集合

Class文件存储格式中对方法的描述与对字段的描述几乎采用了完全一致的方式。方法标的结构如同字段表一样，依次包括了访问标志、名称索引、描述符索引、属性表集合几项。 在这里稍微提一下，**因为volatile修饰符和transient修饰符不可以修饰方法，所以方法表的访问标志中没有这两个对应的标志，但是增加了synchronized、native、abstract等关键字修饰方法，所以也就多了这些关键字对应的标志**

**method_count、access_flags、name_index、descriptor_index、attributes_count、attribute_name_index**

**如果父类方法在子类中没有被重写，方法表集合中就不会出现来自父类的方法信息，有可能会出现由编译器自动添加的方法。**

### 2.7 属性表结合

在Class文件，字段表，方法表中都可以携带自己的属性表集合，以用于描述某些场景专有的信息。与Class文件中其它的数据项目要求的顺序、长 度和内容不同，属性表集合的限制稍微宽松一些，不再要求各个属性表具有严格的顺序，并且只要不与已有的属性名重复，任何人实现的编译器都可以向属性表中写 入自己定义的属性信息，Java虚拟机运行时会忽略掉它不认识的属性
